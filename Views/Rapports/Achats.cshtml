@{
    ViewData["Title"] = "Rapport des achats";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var achats = ViewBag.Achats as List<G_StockVente.Domain.Models.Achat> ?? new List<G_StockVente.Domain.Models.Achat>();
    var boutiques = ViewBag.Boutiques as List<G_StockVente.Domain.Models.Boutique> ?? new List<G_StockVente.Domain.Models.Boutique>();
    var fournisseurs = ViewBag.Fournisseurs as List<G_StockVente.Domain.Models.Fournisseur> ?? new List<G_StockVente.Domain.Models.Fournisseur>();
    var statuts = ViewBag.Statuts as IEnumerable<G_StockVente.Domain.Models.StatutAchat> ?? new List<G_StockVente.Domain.Models.StatutAchat>();
    var isAdminReseau = (bool)ViewBag.IsAdminReseau;
}

<div class="page-header">
    <div>
        <h1 class="page-title">Rapport des achats</h1>
        <p class="page-subtitle">Période, fournisseur, statut et totaux</p>
    </div>
    <div class="page-actions">
        <a asp-controller="Achats" asp-action="Index" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg>
            Ouvrir Achats
        </a>
    </div>
</div>

<!-- Filtres -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6 col-lg-2">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date début
                    </label>
                    <input type="date" 
                           name="dateDebut" 
                           value="@(((DateTime)ViewBag.DateDebut).ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de début" />
                </div>
                <div class="col-12 col-md-6 col-lg-2">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date fin
                    </label>
                    <input type="date" 
                           name="dateFin" 
                           value="@(((DateTime)ViewBag.DateFin).ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de fin" />
                </div>
                @if (isAdminReseau)
                {
                    <div class="col-12 col-md-6 col-lg-2">
                        <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            Boutique
                        </label>
                        <select name="boutiqueId" 
                                class="form-select" 
                                style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                                aria-label="Filtrer par boutique">
                            <option value="">Toutes</option>
                            @foreach (var boutique in boutiques)
                            {
                                <option value="@boutique.Id" selected="@(ViewBag.BoutiqueId?.ToString() == boutique.Id.ToString())">@boutique.Nom</option>
                            }
                        </select>
                    </div>
                }
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Fournisseur
                    </label>
                    <select name="fournisseurId" 
                            class="form-select" 
                            style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                            aria-label="Filtrer par fournisseur">
                        <option value="">Tous</option>
                        @foreach (var fournisseur in fournisseurs)
                    {
                        <option value="@fournisseur.Id" selected="@(ViewBag.FournisseurId?.ToString() == fournisseur.Id.ToString())">@fournisseur.Nom</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><line x1="3" y1="6" x2="21" y2="6"></line><path d="M7 12h10M7 18h10M7 6v12"></path></svg>
                    Statut
                </label>
                <select name="statut" 
                        class="form-select" 
                        style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                        aria-label="Filtrer par statut">
                    <option value="">Tous</option>
                    @foreach (var statut in statuts)
                    {
                        <option value="@((int)statut)" selected="@(ViewBag.Statut?.ToString() == statut.ToString())">@statut</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-2">
                <button type="submit" class="btn btn-primary w-100" style="height: 42px; font-weight: 600;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: var(--space-2);"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                    Appliquer
                </button>
            </div>
        </div>
    </form>
    </div>
</div>

<!-- Statistiques -->
<div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi">
            <p class="kpi__label">Nombre d'achats</p>
            <p class="kpi__value">@ViewBag.NombreAchats</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--info">
            <p class="kpi__label">Total HT</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalHT).ToString("F2")) €</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--warning">
            <p class="kpi__label">Total TVA</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalTVA).ToString("F2")) €</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--success">
            <p class="kpi__label">Total TTC</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalTTC).ToString("F2")) €</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Achats par fournisseur -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                Achats par fournisseur
            </div>
            <div class="card-body">
                @if (ViewBag.AchatsParFournisseur != null)
                {
                    <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Fournisseur</th>
                                <th>Nombre d'achats</th>
                                <th>Montant HT</th>
                                <th>TVA</th>
                                <th>Montant TTC</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.AchatsParFournisseur as dynamic)
                            {
                                <tr>
                                    <td><strong>@item.FournisseurNom</strong></td>
                                    <td>@item.NombreAchats</td>
                                    <td>@(((decimal)item.MontantHT).ToString("F2")) €</td>
                                    <td>@(((decimal)item.MontantTVA).ToString("F2")) €</td>
                                    <td><strong>@(((decimal)item.MontantTTC).ToString("F2")) €</strong></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">Aucune donnée pour cette période.</div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Liste des achats -->
<div class="card">
    <div class="card-header">
        Détail des achats
    </div>
    <div class="card-body">
        @if (!achats.Any())
        {
            <div class="empty-state">Aucun achat sur la période sélectionnée.</div>
        }
        else
        {
            <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Date</th>
                        <th>Boutique</th>
                        <th>Fournisseur</th>
                        <th>Statut</th>
                        <th>HT</th>
                        <th>TVA</th>
                        <th>TTC</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var achat in achats)
                    {
                        <tr>
                            <td><strong>@achat.NumeroAchat</strong></td>
                            <td>@achat.DateCommande.ToString("dd/MM/yyyy")</td>
                            <td>@achat.Boutique.Nom</td>
                            <td>@achat.Fournisseur.Nom</td>
                            <td>
                                <span class="badge bg-@(achat.Statut == G_StockVente.Domain.Models.StatutAchat.Receptionne ? "success" : achat.Statut == G_StockVente.Domain.Models.StatutAchat.Annule ? "danger" : "warning")">
                                    @achat.Statut
                                </span>
                            </td>
                            <td>@achat.MontantHT.ToString("F2") €</td>
                            <td>@achat.MontantTVA.ToString("F2") €</td>
                            <td><strong>@achat.MontantTTC.ToString("F2") €</strong></td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
        }
    </div>
</div>

