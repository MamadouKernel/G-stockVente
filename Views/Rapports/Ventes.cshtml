@{
    ViewData["Title"] = "Rapport des ventes";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var ventes = ViewBag.Ventes as List<G_StockVente.Domain.Models.Vente> ?? new List<G_StockVente.Domain.Models.Vente>();
    var boutiques = ViewBag.Boutiques as List<G_StockVente.Domain.Models.Boutique> ?? new List<G_StockVente.Domain.Models.Boutique>();
    var isAdminReseau = (bool)ViewBag.IsAdminReseau;
}

<div class="page-header">
    <div>
        <h1 class="page-title">Rapport des ventes</h1>
        <p class="page-subtitle">Période, boutique, top produits et export</p>
    </div>
    <div class="page-actions">
        <a asp-action="Ventes" asp-route-format="csv" asp-route-dateDebut="@ViewBag.DateDebut" asp-route-dateFin="@ViewBag.DateFin" asp-route-boutiqueId="@ViewBag.BoutiqueId" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Exporter CSV
        </a>
    </div>
</div>

<!-- Filtres -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4 col-lg-3">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date début
                    </label>
                    <input type="date" 
                           name="dateDebut" 
                           value="@(((DateTime)ViewBag.DateDebut).ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de début" />
                </div>
                <div class="col-12 col-md-4 col-lg-3">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date fin
                    </label>
                    <input type="date" 
                           name="dateFin" 
                           value="@(((DateTime)ViewBag.DateFin).ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de fin" />
                </div>
                @if (isAdminReseau)
                {
                    <div class="col-12 col-md-4 col-lg-3">
                        <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            Boutique
                        </label>
                        <select name="boutiqueId" 
                                class="form-select" 
                                style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                                aria-label="Filtrer par boutique">
                            <option value="">Toutes les boutiques</option>
                            @foreach (var boutique in boutiques)
                            {
                                <option value="@boutique.Id" selected="@(ViewBag.BoutiqueId?.ToString() == boutique.Id.ToString())">@boutique.Nom</option>
                            }
                        </select>
                    </div>
                }
                <div class="col-12 col-lg-2">
                    <button type="submit" class="btn btn-primary w-100" style="height: 42px; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: var(--space-2);"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        Appliquer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Statistiques -->
<div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi">
            <p class="kpi__label">Nombre de ventes</p>
            <p class="kpi__value">@ViewBag.NombreVentes</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--info">
            <p class="kpi__label">Total HT</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalHT).ToString("F2")) €</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--warning">
            <p class="kpi__label">Total TVA</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalTVA).ToString("F2")) €</p>
        </div>
    </div>
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi kpi--success">
            <p class="kpi__label">Total TTC</p>
            <p class="kpi__value">@(((decimal)ViewBag.TotalTTC).ToString("F2")) €</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Ventes par boutique -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                Ventes par boutique
            </div>
            <div class="card-body">
                @if (ViewBag.VentesParBoutique != null)
                {
                    <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Boutique</th>
                                <th>Nombre</th>
                                <th>Montant TTC</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.VentesParBoutique as dynamic)
                            {
                                <tr>
                                    <td>@item.BoutiqueNom</td>
                                    <td>@item.NombreVentes</td>
                                    <td>@(((decimal)item.MontantTTC).ToString("F2")) €</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">Aucune donnée pour cette période.</div>
                }
            </div>
        </div>
    </div>

    <!-- Top produits -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                Top 20 produits vendus
            </div>
            <div class="card-body">
                @if (ViewBag.VentesParProduit != null)
                {
                    <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.VentesParProduit as dynamic)
                            {
                                <tr>
                                    <td>@item.ProduitNom</td>
                                    <td>@item.QuantiteVendue</td>
                                    <td>@(((decimal)item.MontantTotal).ToString("F2")) €</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">Aucune vente sur cette période.</div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Liste des ventes -->
<div class="card">
    <div class="card-header">
        Détail des ventes
    </div>
    <div class="card-body">
        @if (!ventes.Any())
        {
            <div class="empty-state">Aucune vente sur la période sélectionnée.</div>
        }
        else
        {
            <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Date</th>
                        <th>Boutique</th>
                        <th>Caissier</th>
                        <th>HT</th>
                        <th>TVA</th>
                        <th>TTC</th>
                        <th>Paiement</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vente in ventes)
                    {
                        <tr>
                            <td><strong>@vente.NumeroVente</strong></td>
                            <td>@vente.DateVente.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@vente.Boutique.Nom</td>
                            <td>@($"{vente.Utilisateur.Prenom} {vente.Utilisateur.Nom}")</td>
                            <td>@vente.MontantHT.ToString("F2") €</td>
                            <td>@vente.MontantTVA.ToString("F2") €</td>
                            <td><strong>@vente.MontantTTC.ToString("F2") €</strong></td>
                            <td>@vente.ModePaiement</td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
        }
    </div>
</div>


