@model IEnumerable<G_StockVente.Domain.Models.MouvementStock>
@using G_StockVente.Domain.Models
@{
    ViewData["Title"] = "Mouvements de stock";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var total = Model?.Count() ?? 0;
    var dateDebut = (DateTime?)ViewBag.DateDebut;
    var dateFin = (DateTime?)ViewBag.DateFin;
}

<div class="page-header">
    <div>
        <h1 class="page-title">Mouvements de stock</h1>
        <p class="page-subtitle">Traçabilité (entrées, sorties, ajustements) — jusqu'à 500 derniers mouvements</p>
    </div>
    <div class="page-actions">
        <a asp-controller="Stocks" asp-action="Index" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg>
            Retour stocks
        </a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
        <div class="kpi">
            <p class="kpi__label">Mouvements affichés</p>
            <p class="kpi__value">@total</p>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date début
                    </label>
                    <input type="date" 
                           name="dateDebut" 
                           value="@(dateDebut?.ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de début" />
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Date fin
                    </label>
                    <input type="date" 
                           name="dateFin" 
                           value="@(dateFin?.ToString("yyyy-MM-dd"))" 
                           class="form-control" 
                           style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                           aria-label="Date de fin" />
                </div>
                <div class="col-12 col-lg-4">
                    <label class="form-label" style="font-weight: 600; margin-bottom: var(--space-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                        Produit
                    </label>
                    <select name="produitBoutiqueId" 
                            class="form-select" 
                            style="height: 42px; padding: var(--space-3) var(--space-4); font-size: 14px;"
                            asp-items="ViewBag.Produits"
                            aria-label="Filtrer par produit">
                        <option value="">Tous les produits</option>
                    </select>
                </div>
                <div class="col-12 col-lg-2">
                    <button type="submit" class="btn btn-primary w-100" style="height: 42px; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: var(--space-2);"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        Appliquer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Historique</div>
    <div class="card-body">
        @if (Model == null || !Model.Any())
        {
            @await Html.PartialAsync("Components/_EmptyState", "Aucun mouvement sur les critères sélectionnés.")
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Produit</th>
                            <th>Dépôt</th>
                            <th class="text-end">Quantité</th>
                            <th class="text-end">PU</th>
                            <th>Utilisateur</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in Model)
                        {
                            var isEntree = m.Quantite > 0;
                            var isSortie = m.Quantite < 0;
                            <tr>
                                <td>@m.DateMouvement.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    @switch (m.TypeMouvement)
                                    {
                                        case TypeMouvementStock.Entree:
                                            <span class="badge text-bg-success">Entrée</span>
                                            break;
                                        case TypeMouvementStock.Sortie:
                                            <span class="badge text-bg-danger">Sortie</span>
                                            break;
                                        case TypeMouvementStock.Ajustement:
                                            <span class="badge text-bg-warning">Ajustement</span>
                                            break;
                                        default:
                                            <span class="badge text-bg-secondary">@m.TypeMouvement</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <div style="font-weight:800;">@m.ProduitBoutique.Produit.Nom</div>
                                    <div class="text-muted" style="font-size: 13px;">
                                        @(m.ProduitBoutique.Sku ?? "-") · @(m.ProduitBoutique.CodeBarres ?? "-")
                                    </div>
                                </td>
                                <td>@m.Depot.Nom</td>
                                <td class="text-end">
                                    @if (isEntree)
                                    {
                                        <span class="text-success fw-bold">+@m.Quantite</span>
                                    }
                                    else if (isSortie)
                                    {
                                        <span class="text-danger fw-bold">@m.Quantite</span>
                                    }
                                    else
                                    {
                                        <strong>@m.Quantite</strong>
                                    }
                                </td>
                                <td class="text-end">@m.PrixUnitaire.ToString("F2") €</td>
                                <td>@($"{m.Utilisateur.Prenom} {m.Utilisateur.Nom}")</td>
                                <td class="text-muted">@(!string.IsNullOrWhiteSpace(m.Commentaire) ? m.Commentaire : "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>


