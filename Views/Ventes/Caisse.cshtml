@{
    ViewData["Title"] = "Caisse";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var panier = ViewBag.Panier as List<G_StockVente.Infrastructure.Services.LignePanier> ?? new List<G_StockVente.Infrastructure.Services.LignePanier>();
    var totalPanier = ViewBag.TotalPanier as decimal? ?? 0;
    var boutique = ViewBag.Boutique as G_StockVente.Domain.Models.Boutique;
}

<div class="page-header">
    <div>
        <h1 class="page-title">Point de vente</h1>
        <p class="page-subtitle">@boutique?.Nom ¬∑ Caisse N¬∞1</p>
    </div>
    <div class="page-actions">
        <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            Tableau de bord
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-lg-8">
        <!-- Scanner Input -->
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><path d="M8 7v10"></path><path d="M12 7v10"></path><path d="M17 7v10"></path></svg>
                <div>
                    <div style="font-weight: 600;">Scanner produit</div>
                    <small class="text-muted">Code-barres, SKU ou nom du produit</small>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-3">
                    <div class="flex-grow-1 position-relative">
                        <input type="text" id="codeBarresInput" class="form-control form-control-lg" 
                               placeholder="Scannez ou saisissez..." autofocus data-scanner-focus />
                        <div id="webcamContainer" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; margin-top: 8px; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div style="font-weight: 600;">Scanner webcam</div>
                                <button class="btn btn-sm btn-secondary" onclick="fermerWebcam()" style="padding: 4px 12px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    Fermer
                                </button>
                            </div>
                            <div id="interactive" style="width: 100%; max-width: 640px; margin: 0 auto;">
                                <div id="webcamVideo" style="width: 100%; background: #000; border-radius: 4px; aspect-ratio: 4/3; display: flex; align-items: center; justify-content: center; color: white;">
                                    <div class="text-center">
                                        <div class="loader mb-3"></div>
                                        <div>Chargement de la webcam...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-center text-muted" style="font-size: 13px;">
                                Positionnez le code-barres devant la cam√©ra
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary btn-lg" onclick="toggleWebcam()" id="webcamBtn" style="min-width: 100px;" title="Activer/d√©sactiver le scanner webcam">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        <span id="webcamBtnText">Webcam</span>
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="rechercherProduit()" style="min-width: 120px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        Rechercher
                    </button>
                </div>
                <div id="produitResultat"></div>
            </div>
        </div>

        <!-- Panier -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>
                    <div>
                        <div style="font-weight: 600;">Panier</div>
                        @if (panier.Any())
                        {
                            <small class="text-muted">@panier.Count article(s)</small>
                        }
                    </div>
                </div>
                @if (panier.Any())
                {
                    <button class="btn btn-sm btn-danger" onclick="viderPanier()" data-confirm="Voulez-vous vraiment vider le panier ?">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        Vider
                    </button>
                }
            </div>
            <div class="card-body" style="padding: 0;">
                <div id="panierContent">
                    @if (panier.Any())
                    {
                        <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th style="width: 110px;">Quantit√©</th>
                                    <th class="text-end">Prix U.</th>
                                    <th class="text-end">Remise</th>
                                    <th class="text-end" style="width: 120px;">Total TTC</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ligne in panier)
                                {
                                    <tr>
                                        <td>
                                            <div style="font-weight: 600; font-size: 14px;">@ligne.NomProduit</div>
                                        </td>
                                        <td>
                                            <input type="number" value="@ligne.Quantite" min="1" 
                                                   onchange="modifierQuantite('@ligne.ProduitBoutiqueId', this.value)"
                                                   class="form-control form-control-sm" style="width: 70px;" />
                                        </td>
                                        <td class="text-end text-muted">@ligne.PrixUnitaire.ToString("N2", new System.Globalization.CultureInfo("fr-FR")) ‚Ç¨</td>
                                        <td class="text-end">
                                            @if (ligne.Remise > 0)
                                            {
                                                <span class="badge badge-warning">-@ligne.Remise.ToString("F1")%</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">‚Äî</span>
                                            }
                                        </td>
                                        <td class="text-end"><strong style="font-size: 15px;">@ligne.MontantTTC.ToString("N2", new System.Globalization.CultureInfo("fr-FR")) ‚Ç¨</strong></td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="retirerDuPanier('@ligne.ProduitBoutiqueId')"
                                                    title="Retirer"
                                                    style="width: 32px; height: 32px; padding: 0;">√ó</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center" style="background: var(--color-bg); border-top: 2px solid var(--color-border); padding: var(--space-4) var(--space-5);">
                            <div style="font-size: 18px; font-weight: 600; color: var(--color-muted);">Total TTC</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--color-primary);">@totalPanier.ToString("N2", new System.Globalization.CultureInfo("fr-FR")) ‚Ç¨</div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state" style="margin: var(--space-6);">
                            <div class="empty-state-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>
                            </div>
                            <div class="empty-state-title">Panier vide</div>
                            <div class="empty-state-message">Scannez ou recherchez un produit pour commencer.</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card" style="position: sticky; top: 80px;">
            <div class="card-header">
                <div class="d-flex align-items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    <div style="font-weight: 600;">Paiement</div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label class="form-label">Montant total</label>
                    <div style="font-size: 36px; font-weight: 800; color: var(--color-primary); line-height: 1;">
                        @totalPanier.ToString("N2", new System.Globalization.CultureInfo("fr-FR")) ‚Ç¨
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Mode de paiement</label>
                    <select id="modePaiement" class="form-select form-select-lg">
                        <option value="Especes">üíµ Esp√®ces</option>
                        <option value="MobileMoney">üì± Mobile Money</option>
                        <option value="Carte">üí≥ Carte</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="form-label">Commentaire <span class="text-muted">(optionnel)</span></label>
                    <textarea id="commentaire" class="form-control" rows="3" placeholder="Note ou remarque sur cette vente..."></textarea>
                </div>

                <button class="btn btn-success btn-lg w-100" onclick="validerVente()" 
                        @(panier.Any() ? "" : "disabled")
                        style="font-size: 16px; padding: 14px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Valider la vente
                </button>
            </div>
            @if (boutique != null)
            {
                <div class="card-footer" style="background: transparent; border-top: 1px solid var(--color-border); padding: var(--space-3) var(--space-4);">
                    <div style="font-size: 12px; color: var(--color-muted); line-height: 1.6;">
                        <div><strong>Boutique:</strong> @boutique.Nom</div>
                        <div><strong>TVA par d√©faut:</strong> @(boutique.TvaParDefaut.ToString("F2"))%</div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ===== FOCUS SCANNER =====
        // Focus automatique au chargement et apr√®s chaque action
        const scannerInput = document.getElementById('codeBarresInput');
        
        function focusScanner() {
            if (scannerInput) {
                scannerInput.focus();
                scannerInput.select();
            }
        }
        
        // Focus au chargement de la page
        document.addEventListener('DOMContentLoaded', focusScanner);
        
        // Focus quand la fen√™tre redevient active
        window.addEventListener('focus', focusScanner);
        
        // Focus initial imm√©diat
        focusScanner();

        // Recherche au Enter
        scannerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                rechercherProduit();
            }
        });

        // ===== FONCTIONS PANIER =====
        
        // Recharge la page avec focus automatique sur le scanner
        function reloadWithFocus() {
            // Marque pour focus apr√®s reload
            sessionStorage.setItem('focusScanner', 'true');
            location.reload();
        }
        
        // Au chargement, v√©rifie si on doit focus le scanner
        if (sessionStorage.getItem('focusScanner') === 'true') {
            sessionStorage.removeItem('focusScanner');
            setTimeout(focusScanner, 100);
        }

        async function rechercherProduit() {
            const codeBarres = scannerInput.value.trim();
            const resultDiv = document.getElementById('produitResultat');
            
            if (!codeBarres) {
                Toast.warning('Veuillez saisir un code-barres ou un nom de produit.');
                focusScanner();
                return;
            }

            // Show loading
            resultDiv.innerHTML = '<div class="alert alert-info d-flex align-items-center gap-2"><div class="loader loader-sm"></div> Recherche en cours...</div>';

            try {
                const response = await fetch('/Produits/RechercherParCodeBarres?codeBarres=' + encodeURIComponent(codeBarres));
                const data = await response.json();
                
                if (data.success) {
                    await ajouterAuPanier(data.produit.id, 1);
                    // Le reload se fait dans ajouterAuPanier avec focusScanner
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning d-flex align-items-center justify-content-between">
                            <span>Produit non trouv√© : <strong>${codeBarres}</strong></span>
                            <a href="/Produits/Create" class="btn btn-sm btn-warning">Cr√©er le produit</a>
                        </div>
                    `;
                    Toast.warning('Produit non trouv√©.');
                    focusScanner();
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Erreur lors de la recherche.</div>';
                Toast.error('Erreur: ' + error.message);
                focusScanner();
            }
        }

        async function ajouterAuPanier(produitBoutiqueId, quantite) {
            try {
                const response = await fetch('/Ventes/AjouterAuPanier', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ produitBoutiqueId, quantite })
                });
                const data = await response.json();
                if (data.success) {
                    Toast.success('Produit ajout√© au panier !');
                    reloadWithFocus();
                } else {
                    Toast.error(data.message || 'Erreur lors de l\'ajout au panier.');
                    focusScanner();
                }
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
                focusScanner();
            }
        }

        async function modifierQuantite(produitBoutiqueId, quantite) {
            try {
                const response = await fetch('/Ventes/ModifierQuantite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ produitBoutiqueId, quantite: parseInt(quantite) })
                });
                const data = await response.json();
                if (data.success) {
                    reloadWithFocus();
                } else {
                    Toast.error(data.message || 'Erreur lors de la modification.');
                }
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
            }
        }

        async function retirerDuPanier(produitBoutiqueId) {
            const confirmed = await Modal.confirm({
                title: 'Retirer du panier',
                message: 'Voulez-vous retirer cet article du panier ?',
                confirmText: 'Retirer',
                danger: true
            });
            
            if (!confirmed) {
                focusScanner();
                return;
            }

            try {
                const response = await fetch('/Ventes/RetirerDuPanier', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ produitBoutiqueId })
                });
                const data = await response.json();
                if (data.success) {
                    Toast.success('Article retir√© du panier.');
                    reloadWithFocus();
                } else {
                    Toast.error(data.message || 'Erreur lors de la suppression.');
                    focusScanner();
                }
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
                focusScanner();
            }
        }

        async function viderPanier() {
            const confirmed = await Modal.confirm({
                title: 'Vider le panier',
                message: 'Voulez-vous vraiment vider tout le panier ?',
                confirmText: 'Vider',
                danger: true
            });
            
            if (!confirmed) {
                focusScanner();
                return;
            }
            
            try {
                const response = await fetch('/Ventes/ViderPanier', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                const data = await response.json();
                if (data.success) {
                    Toast.success('Panier vid√©.');
                    reloadWithFocus();
                } else {
                    Toast.error(data.message || 'Erreur.');
                    focusScanner();
                }
            } catch (error) {
                Toast.error('Erreur: ' + error.message);
                focusScanner();
            }
        }

        async function validerVente() {
            const modePaiement = document.getElementById('modePaiement').value;
            const commentaire = document.getElementById('commentaire').value;

            const confirmed = await Modal.confirm({
                title: 'Valider la vente',
                message: `Confirmer la vente de <strong>${@totalPanier.ToString("N2", new System.Globalization.CultureInfo("fr-FR"))} ‚Ç¨</strong> ?`,
                confirmText: 'Valider'
            });
            
            if (!confirmed) {
                focusScanner();
                return;
            }

            const button = event.target;
            LoadingState.show(button);

            try {
                const response = await fetch('/Ventes/ValiderVente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ modePaiement, commentaire })
                });
                const data = await response.json();
                
                LoadingState.hide(button);
                
                if (data.success) {
                    await Modal.confirm({
                        title: 'Vente valid√©e !',
                        message: `Num√©ro de vente : <strong>${data.numeroVente}</strong>`,
                        confirmText: 'OK',
                        cancelText: 'Imprimer ticket'
                    });
                    reloadWithFocus();
                } else {
                    Toast.error(data.message || 'Impossible de valider la vente.');
                    focusScanner();
                }
            } catch (error) {
                LoadingState.hide(button);
                Toast.error('Erreur: ' + error.message);
                focusScanner();
            }
        }

        // ===== SCANNER WEBCAM =====
        let webcamActive = false;
        let quaggaInitialized = false;

        async function toggleWebcam() {
            if (webcamActive) {
                fermerWebcam();
            } else {
                await ouvrirWebcam();
            }
        }

        async function ouvrirWebcam() {
            const container = document.getElementById('webcamContainer');
            const videoDiv = document.getElementById('webcamVideo');
            
            if (!container || !videoDiv) return;

            // V√©rifier si le navigateur supporte getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                Toast.error('Votre navigateur ne supporte pas la webcam. Veuillez utiliser un navigateur moderne (Chrome, Firefox, Edge).');
                return;
            }

            container.style.display = 'block';
            videoDiv.innerHTML = '<div class="text-center"><div class="loader mb-3"></div><div>Chargement de la webcam...</div></div>';

            try {
                // Charger QuaggaJS depuis CDN si pas d√©j√† charg√©
                if (typeof Quagga === 'undefined') {
                    await loadQuaggaJS();
                }

                // Initialiser QuaggaJS
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: videoDiv,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" // Cam√©ra arri√®re si disponible
                        }
                    },
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "code_39_vin_reader",
                            "codabar_reader",
                            "upc_reader",
                            "upc_e_reader",
                            "i2of5_reader"
                        ]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error('Erreur Quagga:', err);
                        videoDiv.innerHTML = `
                            <div class="text-center text-danger p-4">
                                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                                <div style="font-weight: 600; margin-bottom: 8px;">Erreur de webcam</div>
                                <div style="font-size: 14px;">${err.message || 'Impossible d\'acc√©der √† la webcam'}</div>
                                <button class="btn btn-sm btn-primary mt-3" onclick="fermerWebcam()">Fermer</button>
                            </div>
                        `;
                        Toast.error('Impossible d\'acc√©der √† la webcam. V√©rifiez vos permissions.');
                        return;
                    }
                    Quagga.start();
                    quaggaInitialized = true;
                });

                // √âcouter la d√©tection de code-barres
                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    if (code) {
                        // Remplir le champ et rechercher automatiquement
                        scannerInput.value = code;
                        Toast.success(`Code-barres d√©tect√©: ${code}`);
                        
                        // Fermer la webcam
                        fermerWebcam();
                        
                        // Rechercher le produit
                        rechercherProduit();
                    }
                });

                webcamActive = true;
                document.getElementById('webcamBtnText').textContent = 'Fermer';
                document.getElementById('webcamBtn').classList.remove('btn-outline-primary');
                document.getElementById('webcamBtn').classList.add('btn-danger');

            } catch (error) {
                console.error('Erreur webcam:', error);
                videoDiv.innerHTML = `
                    <div class="text-center text-danger p-4">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Erreur</div>
                        <div style="font-size: 14px;">${error.message || 'Impossible d\'acc√©der √† la webcam'}</div>
                        <button class="btn btn-sm btn-primary mt-3" onclick="fermerWebcam()">Fermer</button>
                    </div>
                `;
                Toast.error('Erreur: ' + error.message);
            }
        }

        function fermerWebcam() {
            const container = document.getElementById('webcamContainer');
            if (quaggaInitialized && typeof Quagga !== 'undefined') {
                Quagga.stop();
                quaggaInitialized = false;
            }
            if (container) {
                container.style.display = 'none';
            }
            webcamActive = false;
            document.getElementById('webcamBtnText').textContent = 'Webcam';
            const webcamBtn = document.getElementById('webcamBtn');
            webcamBtn.classList.remove('btn-danger');
            webcamBtn.classList.add('btn-outline-primary');
            
            // R√©initialiser la div vid√©o
            const videoDiv = document.getElementById('webcamVideo');
            if (videoDiv) {
                videoDiv.innerHTML = '<div class="text-center"><div class="loader mb-3"></div><div>Chargement de la webcam...</div></div>';
            }
            
            // Refocus sur l'input scanner
            focusScanner();
        }

        async function loadQuaggaJS() {
            return new Promise((resolve, reject) => {
                // V√©rifier si QuaggaJS est d√©j√† charg√©
                if (typeof Quagga !== 'undefined') {
                    resolve();
                    return;
                }

                // Charger QuaggaJS depuis CDN
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Impossible de charger QuaggaJS'));
                document.head.appendChild(script);
            });
        }

        // Nettoyer √† la fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (quaggaInitialized && typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
        });
    </script>
    
    <style>
        #interactive {
            position: relative;
        }
        #interactive video {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3481c0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        .loader-sm {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
}

